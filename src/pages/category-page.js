'use strict';

(function (window, document, undefined, paneiro, jambo) {
  var categoryPathMap = {};
  var categories = paneiro.config.categories;
  for (var i = 0, len = categories.length; i < len; ++i) {
    categoryPathMap[categories[i].path] = categories[i];
  }

  Polymer({
    is: 'category-page',

    properties: {
      cart: Object,
      categoryName: String,
      firstLoad: {
        type: Array,
        notify: true
      },
      hasNext: {
        type: Boolean,
        value: false
      },
      products: {
        type: Array,
        notify: true
      },
      page: Number,
      route: Object,
      selectedCategory: {
        type: String,
        notify: true
      }
    },

    observers: ['_routeCategoryChanged(routeData.category)'],

    _routeCategoryChanged: function _routeCategoryChanged(category) {
      if (this.firstLoad) {
        this.products = [];
      } else {
        paneiro.sharedElements.loadingProgress.classList.add('transiting');
        paneiro.sharedElements.loadingProgress.value = 85;
      }

      category = category || 'petshop';

      var categoryData = categoryPathMap[category];

      this.hasNext = false;
      this.selectedCategory = category;
      this.page = 1;
      this.categoryName = categoryData.name;
      this._loadCategoryProducts(categoryData.id, this.page);
    },

    _loadCategoryProducts: function _loadCategoryProducts(categoryId, page) {
      var _this = this;

      paneiro.api.product.get({
        category: categoryId,
        page: page
      }).then(function (response) {
        if (page === 1) {
          _this.products = response.data;
          _this.products.forEach(function (product) {
            product.qty = 1;
          });
          window.scrollTo(0, 0);
        } else {
          response.data.forEach(function (product) {
            product.qty = 1;
            _this.push('products', product);
          });
        }

        _this.hasNext = response.paging !== undefined && response.paging.next !== undefined;

        if (!_this.firstLoad) {
          paneiro.sharedElements.loadingProgress.value = 100;
          paneiro.sharedElements.loadingProgress.classList.remove('transiting');

          setTimeout(function () {
            paneiro.sharedElements.loadingProgress.value = 0;
          }, 300);
        }

        _this.firstLoad = false;
      });
    },

    onIncQtyTap: function onIncQtyTap(e) {
      if (e.model.product.qty < 9) {
        e.model.set('product.qty', e.model.product.qty + 1);
      }
    },

    onDecQtyTap: function onDecQtyTap(e) {
      if (e.model.product.qty > 0) {
        e.model.set('product.qty', e.model.product.qty - 1);
      }
    },

    onAddToCartTap: function onAddToCartTap(e) {
      var _this2 = this;

      var product = e.model.product;

      var qty = product.qty;
      var price = product.price;

      paneiro.api.cart.addProduct({
        id: product.id,
        qty: product.qty
      }).then(function (response) {
        _this2.$.addedToCartToast.open();

        var idx = _this2.cart.items.findIndex(function (element, index, array) {
          return element.id === product.id;
        });

        if (idx > -1) {
          _this2.set('cart.items.' + idx + '.qty', _this2.cart.items[idx].qty + qty);
        } else {
          var p = jambo.deepExtend({}, product);
          p.qty = qty;

          _this2.push('cart.items', p);
        }

        _this2.set('cart.total', _this2.cart.total + qty * product.price);
      }).catch(function (err) {
        return console.log(err);
      });

      e.model.set('product.qty', 0);
    },

    onLoadMoreTap: function onLoadMoreTap() {
      this.page++;

      var categoryData = categoryPathMap[this.selectedCategory];
      this._loadCategoryProducts(categoryData.id, this.page);

      if (!this.firstLoad) {
        paneiro.sharedElements.loadingProgress.classList.add('transiting');
        paneiro.sharedElements.loadingProgress.value = 85;
      }
    }
  });
})(window, document, undefined, paneiro, jambo);
//# sourceMappingURL=data:application/json;base64,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QWdKeUIsU0FoSnpCLEVBZ0pvQyxPQWhKcEMsRUFnSjZDLEtBaEo3QyIsImZpbGUiOiJwYWdlcy9jYXRlZ29yeS1wYWdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCwgcGFuZWlybywgamFtYm8pIHtcbiAgICAgIHZhciBjYXRlZ29yeVBhdGhNYXAgPSB7fTtcbiAgICAgIHZhciBjYXRlZ29yaWVzID0gcGFuZWlyby5jb25maWcuY2F0ZWdvcmllcztcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjYXRlZ29yaWVzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgIGNhdGVnb3J5UGF0aE1hcFtjYXRlZ29yaWVzW2ldLnBhdGhdID0gY2F0ZWdvcmllc1tpXTtcbiAgICAgIH0gICAgICBcblxuICAgICAgUG9seW1lcih7XG4gICAgICAgIGlzOiAnY2F0ZWdvcnktcGFnZScsXG5cbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIGNhcnQ6IE9iamVjdCwgICAgICAgICAgXG4gICAgICAgICAgY2F0ZWdvcnlOYW1lOiBTdHJpbmcsXG4gICAgICAgICAgZmlyc3RMb2FkOiB7XG4gICAgICAgICAgICB0eXBlOiBBcnJheSxcbiAgICAgICAgICAgIG5vdGlmeTogdHJ1ZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgaGFzTmV4dDoge1xuICAgICAgICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgICAgICAgIHZhbHVlOiBmYWxzZVxuICAgICAgICAgIH0sICAgICAgICAgIFxuICAgICAgICAgIHByb2R1Y3RzOiB7XG4gICAgICAgICAgICB0eXBlOiBBcnJheSxcbiAgICAgICAgICAgIG5vdGlmeTogdHJ1ZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgcGFnZTogTnVtYmVyLFxuICAgICAgICAgIHJvdXRlOiBPYmplY3QsXG4gICAgICAgICAgc2VsZWN0ZWRDYXRlZ29yeToge1xuICAgICAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICAgICAgbm90aWZ5OiB0cnVlXG4gICAgICAgICAgfSAgICAgICAgICBcbiAgICAgICAgfSwgICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIG9ic2VydmVyczogW1xuICAgICAgICAgICdfcm91dGVDYXRlZ29yeUNoYW5nZWQocm91dGVEYXRhLmNhdGVnb3J5KSdcbiAgICAgICAgXSwgICAgICAgIFxuXG4gICAgICAgIF9yb3V0ZUNhdGVnb3J5Q2hhbmdlZDogZnVuY3Rpb24oY2F0ZWdvcnkpIHtcbiAgICAgICAgICBpZiAodGhpcy5maXJzdExvYWQpIHtcbiAgICAgICAgICAgIHRoaXMucHJvZHVjdHMgPSBbXTsgICAgICAgICAgICBcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFuZWlyby5zaGFyZWRFbGVtZW50cy5sb2FkaW5nUHJvZ3Jlc3MuY2xhc3NMaXN0LmFkZCgndHJhbnNpdGluZycpOyAgICAgICAgICAgIFxuICAgICAgICAgICAgcGFuZWlyby5zaGFyZWRFbGVtZW50cy5sb2FkaW5nUHJvZ3Jlc3MudmFsdWUgPSA4NTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjYXRlZ29yeSA9IGNhdGVnb3J5IHx8ICdwZXRzaG9wJzsgXG5cbiAgICAgICAgICB2YXIgY2F0ZWdvcnlEYXRhID0gY2F0ZWdvcnlQYXRoTWFwW2NhdGVnb3J5XTsgICAgICAgICAgXG5cbiAgICAgICAgICB0aGlzLmhhc05leHQgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLnNlbGVjdGVkQ2F0ZWdvcnkgPSBjYXRlZ29yeTtcbiAgICAgICAgICB0aGlzLnBhZ2UgPSAxO1xuICAgICAgICAgIHRoaXMuY2F0ZWdvcnlOYW1lID0gY2F0ZWdvcnlEYXRhLm5hbWU7XG4gICAgICAgICAgdGhpcy5fbG9hZENhdGVnb3J5UHJvZHVjdHMoY2F0ZWdvcnlEYXRhLmlkLCB0aGlzLnBhZ2UpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0sICAgICAgICBcblxuICAgICAgICBfbG9hZENhdGVnb3J5UHJvZHVjdHM6IGZ1bmN0aW9uKGNhdGVnb3J5SWQsIHBhZ2UpIHsgICAgICAgIFxuICAgICAgICAgIHBhbmVpcm8uYXBpLnByb2R1Y3QuZ2V0KHtcbiAgICAgICAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeUlkLFxuICAgICAgICAgICAgcGFnZTogcGFnZVxuICAgICAgICAgIH0pLnRoZW4ocmVzcG9uc2UgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHBhZ2UgPT09IDEpIHtcbiAgICAgICAgICAgICAgdGhpcy5wcm9kdWN0cyA9IHJlc3BvbnNlLmRhdGE7XG4gICAgICAgICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChwcm9kdWN0ID0+IHtcbiAgICAgICAgICAgICAgICBwcm9kdWN0LnF0eSA9IDE7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7XG4gICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaChwcm9kdWN0ID0+IHtcbiAgICAgICAgICAgICAgICBwcm9kdWN0LnF0eSA9IDE7XG4gICAgICAgICAgICAgICAgdGhpcy5wdXNoKCdwcm9kdWN0cycsIHByb2R1Y3QpOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuaGFzTmV4dCA9IChyZXNwb25zZS5wYWdpbmcgIT09IHVuZGVmaW5lZCAmJiByZXNwb25zZS5wYWdpbmcubmV4dCAhPT0gdW5kZWZpbmVkKTsgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCF0aGlzLmZpcnN0TG9hZCkge1xuICAgICAgICAgICAgICBwYW5laXJvLnNoYXJlZEVsZW1lbnRzLmxvYWRpbmdQcm9ncmVzcy52YWx1ZSA9IDEwMDtcbiAgICAgICAgICAgICAgcGFuZWlyby5zaGFyZWRFbGVtZW50cy5sb2FkaW5nUHJvZ3Jlc3MuY2xhc3NMaXN0LnJlbW92ZSgndHJhbnNpdGluZycpO1xuXG4gICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHBhbmVpcm8uc2hhcmVkRWxlbWVudHMubG9hZGluZ1Byb2dyZXNzLnZhbHVlID0gMDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIH0sIDMwMCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmZpcnN0TG9hZCA9IGZhbHNlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuXG4gICAgICAgIG9uSW5jUXR5VGFwOiBmdW5jdGlvbihlKSB7ICAgICAgICAgIFxuICAgICAgICAgIGlmIChlLm1vZGVsLnByb2R1Y3QucXR5IDwgOSkge1xuICAgICAgICAgICAgZS5tb2RlbC5zZXQoJ3Byb2R1Y3QucXR5JywgZS5tb2RlbC5wcm9kdWN0LnF0eSArIDEpO1xuICAgICAgICAgIH0gICAgICAgICAgXG4gICAgICAgIH0sXG5cbiAgICAgICAgb25EZWNRdHlUYXA6IGZ1bmN0aW9uKGUpIHsgICAgICAgICAgXG4gICAgICAgICAgaWYgKGUubW9kZWwucHJvZHVjdC5xdHkgPiAwKSB7XG4gICAgICAgICAgICBlLm1vZGVsLnNldCgncHJvZHVjdC5xdHknLCBlLm1vZGVsLnByb2R1Y3QucXR5IC0gMSk7XG4gICAgICAgICAgfSAgICAgICAgICBcbiAgICAgICAgfSxcblxuICAgICAgICBvbkFkZFRvQ2FydFRhcDogZnVuY3Rpb24oZSkge1xuICAgICAgICAgIHZhciBwcm9kdWN0ID0gZS5tb2RlbC5wcm9kdWN0O1xuXG4gICAgICAgICAgdmFyIHF0eSA9IHByb2R1Y3QucXR5O1xuICAgICAgICAgIHZhciBwcmljZSA9IHByb2R1Y3QucHJpY2U7XG4gICAgICAgICAgXG4gICAgICAgICAgcGFuZWlyby5hcGkuY2FydC5hZGRQcm9kdWN0KHtcbiAgICAgICAgICAgIGlkOiBwcm9kdWN0LmlkLFxuICAgICAgICAgICAgcXR5OiBwcm9kdWN0LnF0eVxuICAgICAgICAgIH0pLnRoZW4ocmVzcG9uc2UgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy4kLmFkZGVkVG9DYXJ0VG9hc3Qub3BlbigpO1xuXG4gICAgICAgICAgICB2YXIgaWR4ID0gdGhpcy5jYXJ0Lml0ZW1zLmZpbmRJbmRleCgoZWxlbWVudCwgaW5kZXgsIGFycmF5KSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlkID09PSBwcm9kdWN0LmlkO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChpZHggPiAtMSkge1xuICAgICAgICAgICAgICB0aGlzLnNldCgnY2FydC5pdGVtcy4nICsgaWR4ICsgJy5xdHknLCB0aGlzLmNhcnQuaXRlbXNbaWR4XS5xdHkgKyBxdHkpOyAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB2YXIgcCA9IGphbWJvLmRlZXBFeHRlbmQoe30sIHByb2R1Y3QpO1xuICAgICAgICAgICAgICBwLnF0eSA9IHF0eTtcblxuICAgICAgICAgICAgICB0aGlzLnB1c2goJ2NhcnQuaXRlbXMnLCBwKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5zZXQoJ2NhcnQudG90YWwnLCB0aGlzLmNhcnQudG90YWwgKyBxdHkqcHJvZHVjdC5wcmljZSk7XG4gICAgICAgICAgfSkuY2F0Y2goZXJyID0+IGNvbnNvbGUubG9nKGVycikpO1xuXG4gICAgICAgICAgZS5tb2RlbC5zZXQoJ3Byb2R1Y3QucXR5JywgMCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgb25Mb2FkTW9yZVRhcDogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgdGhpcy5wYWdlKys7XG5cbiAgICAgICAgICB2YXIgY2F0ZWdvcnlEYXRhID0gY2F0ZWdvcnlQYXRoTWFwW3RoaXMuc2VsZWN0ZWRDYXRlZ29yeV07XG4gICAgICAgICAgdGhpcy5fbG9hZENhdGVnb3J5UHJvZHVjdHMoY2F0ZWdvcnlEYXRhLmlkLCB0aGlzLnBhZ2UpO1xuXG4gICAgICAgICAgaWYgKCF0aGlzLmZpcnN0TG9hZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcGFuZWlyby5zaGFyZWRFbGVtZW50cy5sb2FkaW5nUHJvZ3Jlc3MuY2xhc3NMaXN0LmFkZCgndHJhbnNpdGluZycpOyAgICAgICAgICAgIFxuICAgICAgICAgICAgcGFuZWlyby5zaGFyZWRFbGVtZW50cy5sb2FkaW5nUHJvZ3Jlc3MudmFsdWUgPSA4NTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCwgcGFuZWlybywgamFtYm8pOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
