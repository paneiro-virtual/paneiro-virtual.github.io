<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">


<link rel="import" href="../elements/product-grid.html">
<link rel="import" href="../paneiro-theme.html">

</head><body><dom-module id="category-page">
  <template>
    <style>:host{display:block;}.main-content{padding:48px 8px;}#loadMoreWrapper{text-align:center;}#loadMoreButton{@apply (--paper-font-button);background:var(--primary-color);color:#fff;margin:16px;}paper-spinner-lite{height:50px;width:50px;display:block;margin:0 auto;--paper-spinner-color:var(--primary-color);--paper-spinner-stroke-width:4px;}paper-spinner-lite:not([active]){display:none;}.page-title{@apply (--paper-font-display1);margin:0 8px 16px 0;}@media screen and (max-width: 780px){.page-title{@apply (--paper-font-headline);}}</style>
    
    <app-route route="{{route}}" pattern="/:category" data="{{routeData}}">
    </app-route>    
            
    <main class="container main-content">
      <div class="page-title">
        {{categoryName}}
      </div>      

      <paper-spinner-lite id="loadingSpinner" active="{{firstLoad}}"></paper-spinner-lite>      
      
      <product-grid products="{{products}}" cart="{{cart}}"></product-grid>
      
      <template is="dom-if" if="{{hasNext}}">
        <div id="loadMoreWrapper">
          <paper-button id="loadMoreButton" on-tap="onLoadMoreTap">Ver mais produtos</paper-button>
        </div>
      </template>                                
    </main>    
  </template>

  <script>
    (function(window, document, undefined, paneiro, jambo) {
      var categoryPathMap = {};
      var categories = paneiro.config.categories;
      for (var i = 0, len = categories.length; i < len; ++i) {
        categoryPathMap[categories[i].path] = categories[i];
      }      

      Polymer({
        is: 'category-page',

        properties: {
          cart: Object,          
          categoryName: String,
          firstLoad: {
            type: Array,
            notify: true
          },
          hasNext: {
            type: Boolean,
            value: false
          },          
          products: {
            type: Array,
            notify: true
          },
          page: Number,
          route: Object,
          selectedCategory: {
            type: String,
            notify: true
          }          
        },                       

        observers: [
          '_routeCategoryChanged(routeData.category)'
        ],        

        _routeCategoryChanged: function(category) {
          if (this.firstLoad) {
            this.products = [];            
          } else {
            paneiro.sharedElements.loadingProgress.classList.add('transiting');            
            paneiro.sharedElements.loadingProgress.value = 85;
          }

          category = category || 'petshop'; 

          var categoryData = categoryPathMap[category];          

          this.hasNext = false;
          this.selectedCategory = category;
          this.page = 1;
          this.categoryName = categoryData.name;
          this._loadCategoryProducts(categoryData.id, this.page);                    
        },        

        _loadCategoryProducts: function(categoryId, page) {        
          paneiro.api.product.get({
            category: categoryId,
            page: page
          }).then(response => {            
            if (page === 1) {
              this.products = response.data;
              this.products.forEach(product => {
                product.qty = 1;
              });
              window.scrollTo(0, 0);
            } else {              
              response.data.forEach(product => {
                product.qty = 1;
                this.push('products', product);                
              });
            }

            this.hasNext = (response.paging !== undefined && response.paging.next !== undefined);                        
            
            if (!this.firstLoad) {
              paneiro.sharedElements.loadingProgress.value = 100;
              paneiro.sharedElements.loadingProgress.classList.remove('transiting');

              setTimeout(() => {
                paneiro.sharedElements.loadingProgress.value = 0;                
              }, 300);                
            }
            
            this.firstLoad = false;                                                                  
          });
        },

        onIncQtyTap: function(e) {          
          if (e.model.product.qty < 9) {
            e.model.set('product.qty', e.model.product.qty + 1);
          }          
        },

        onDecQtyTap: function(e) {          
          if (e.model.product.qty > 0) {
            e.model.set('product.qty', e.model.product.qty - 1);
          }          
        },

        onAddToCartTap: function(e) {
          var product = e.model.product;

          var qty = product.qty;
          var price = product.price;
          
          paneiro.api.cart.addProduct({
            id: product.id,
            qty: product.qty
          }).then(response => {            
            this.$.addedToCartToast.open();

            var idx = this.cart.items.findIndex((element, index, array) => {
              return element.id === product.id;
            });            

            if (idx > -1) {
              this.set('cart.items.' + idx + '.qty', this.cart.items[idx].qty + qty);              
            } else {
              var p = jambo.deepExtend({}, product);
              p.qty = qty;

              this.push('cart.items', p);
            }

            this.set('cart.total', this.cart.total + qty*product.price);
          }).catch(err => console.log(err));

          e.model.set('product.qty', 0);
        },

        onLoadMoreTap: function() {
          this.page++;

          var categoryData = categoryPathMap[this.selectedCategory];
          this._loadCategoryProducts(categoryData.id, this.page);

          if (!this.firstLoad) {            
            paneiro.sharedElements.loadingProgress.classList.add('transiting');            
            paneiro.sharedElements.loadingProgress.value = 85;
          }
        }
      });
    })(window, document, undefined, paneiro, jambo);    
  </script>
</dom-module>
</body></html>