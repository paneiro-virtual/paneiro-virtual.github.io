'use strict';

(function (window, document, undefined, paneiro, jambo) {
  var pathElementMap = {
    'categoria': 'category-page',
    'busca': 'search-page',
    'fechar-pedido': 'checkout-page'
  };

  Polymer({
    is: 'store-main-page',

    properties: {
      categories: Object,
      cart: {
        type: Object,
        notify: true
      },
      firstLoad: Boolean,
      route: Object,
      user: Object,
      page: {
        type: String,
        reflectToAttribute: true,
        observer: '_pageChanged'
      },
      selectedCategory: {
        type: String,
        notify: true
      }
    },

    attached: function attached() {
      if (!paneiro.userToken || paneiro.userToken === '') {
        this.$.ironLocation.set('path', '/');
      }
    },

    observers: ['_routePageChanged(routeData.page)'],

    _routePageChanged: function _routePageChanged(page) {
      var _this = this;

      if (paneiro.userToken) {
        var promise = !this.user ? this._loadUserData() : Promise.resolve();
        promise.then(function () {
          _this.$.loadingSpinner.active = false;
          _this.page = page || 'categoria';
        });
      }
    },

    _pageChanged: function _pageChanged(page) {
      if (pathElementMap[page]) {
        this.importHref(this.resolveUrl('./' + pathElementMap[page] + '.html'), null, null, true);
      }
      this.firstLoad = true;
    },

    currencyFormat: function currencyFormat(val) {
      return paneiro.commons.currencyFormat(val);
    },

    totalCartItemPrice: function totalCartItemPrice(qty, price) {
      return this.currencyFormat(qty * price);
    },

    totalCartPrice: function totalCartPrice(price) {
      return this.currencyFormat(paneiro.config.shippingPrice + price);
    },

    onRemoveCartItemTap: function onRemoveCartItemTap(e) {
      var _this2 = this;

      var cartItem = e.model.item;
      var idx = this.cart.items.indexOf(cartItem);
      var itemPrice = cartItem.price * cartItem.qty;

      paneiro.api.cart.removeProduct({ id: cartItem.id }).then(function (response) {
        _this2.splice('cart.items', idx, 1);
        _this2.set('cart.total', _this2.cart.total - itemPrice);
      }).catch(function (err) {
        return console.log(err);
      });
    },

    onIncCartItemQtyTap: function onIncCartItemQtyTap(e) {
      var _this3 = this;

      var cartItem = e.model.item;
      var idx = this.cart.items.indexOf(cartItem);

      paneiro.api.cart.addProduct({
        id: cartItem.id,
        qty: 1
      }).then(function (response) {
        _this3.set('cart.items.' + idx + '.qty', cartItem.qty + 1);
        _this3.set('cart.total', _this3.cart.total + cartItem.price);
      }).catch(function (err) {
        return console.log(err);
      });
    },

    onDecCartItemQtyTap: function onDecCartItemQtyTap(e) {
      var _this4 = this;

      var cartItem = e.model.item;
      var idx = this.cart.items.indexOf(cartItem);

      paneiro.api.cart.removeProduct({
        id: cartItem.id,
        qty: 1
      }).then(function (response) {
        if (cartItem.qty === 1) {
          _this4.splice('cart.items', idx, 1);
        } else {
          _this4.set('cart.items.' + idx + '.qty', cartItem.qty - 1);
        }
        _this4.set('cart.total', _this4.cart.total - cartItem.price);
      }).catch(function (err) {
        return console.log(err);
      });
    },

    onSearchFormPresubmit: function onSearchFormPresubmit(e) {
      e.preventDefault();

      this.$.ironLocation.query = 'q=' + this.$.searchForm.serialize().search;
      this.$.ironLocation.path = '/loja/busca';
    },

    onCheckoutButtonTap: function onCheckoutButtonTap(e) {
      this.set('route.path', '/fechar-pedido');
      this.$.cartDrawer.toggle();
    },

    _loadUserData: function _loadUserData() {
      var _this5 = this;

      var getCartPromise = paneiro.api.cart.get();
      getCartPromise.then(function (response) {
        _this5.cart = response.data;
        _this5.$.cartDrawerLoadingSpinner.active = false;
      }).catch(function (err) {
        return console.log(err);
      });

      var getUserPromise = paneiro.api.user.getData({
        userToken: paneiro.userToken
      });
      getUserPromise.then(function (user) {
        return _this5.user = user;
      });

      return new Promise(function (resolve, reject) {
        Promise.all([getCartPromise, getUserPromise]).then(function () {
          resolve();
        });
      });
    }
  });
})(window, document, undefined, paneiro, jambo);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhZ2VzL3N0b3JlLW1haW4tcGFnZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLENBQUMsVUFBUyxNQUFULEVBQWlCLFFBQWpCLEVBQTJCLFNBQTNCLEVBQXNDLE9BQXRDLEVBQStDLEtBQS9DLEVBQXNEO0FBQ2pELE1BQUksaUJBQWlCO0FBQ25CLGlCQUFhLGVBRE07QUFFbkIsYUFBUyxhQUZVO0FBR25CLHFCQUFpQjtBQUhFLEdBQXJCOztBQU1BLFVBQVE7QUFDTixRQUFJLGlCQURFOztBQUdOLGdCQUFZO0FBQ1Ysa0JBQVksTUFERjtBQUVWLFlBQU07QUFDSixjQUFNLE1BREY7QUFFSixnQkFBUTtBQUZKLE9BRkk7QUFNVixpQkFBVyxPQU5EO0FBT1YsYUFBTyxNQVBHO0FBUVYsWUFBTSxNQVJJO0FBU1YsWUFBTTtBQUNKLGNBQU0sTUFERjtBQUVKLDRCQUFvQixJQUZoQjtBQUdKLGtCQUFVO0FBSE4sT0FUSTtBQWNWLHdCQUFrQjtBQUNoQixjQUFNLE1BRFU7QUFFaEIsZ0JBQVE7QUFGUTtBQWRSLEtBSE47O0FBdUJOLGNBQVUsb0JBQVc7QUFDbkIsVUFBSSxDQUFDLFFBQVEsU0FBVCxJQUFzQixRQUFRLFNBQVIsS0FBc0IsRUFBaEQsRUFBb0Q7QUFDbEQsYUFBSyxDQUFMLENBQU8sWUFBUCxDQUFvQixHQUFwQixDQUF3QixNQUF4QixFQUFnQyxHQUFoQztBQUNEO0FBQ0YsS0EzQks7O0FBNkJOLGVBQVcsQ0FDVCxtQ0FEUyxDQTdCTDs7QUFpQ04sdUJBQW1CLDJCQUFTLElBQVQsRUFBZTtBQUFBOztBQUNoQyxVQUFJLFFBQVEsU0FBWixFQUF1QjtBQUNyQixZQUFJLFVBQVcsQ0FBQyxLQUFLLElBQVAsR0FBZSxLQUFLLGFBQUwsRUFBZixHQUFzQyxRQUFRLE9BQVIsRUFBcEQ7QUFDQSxnQkFBUSxJQUFSLENBQWEsWUFBTTtBQUNqQixnQkFBSyxDQUFMLENBQU8sY0FBUCxDQUFzQixNQUF0QixHQUErQixLQUEvQjtBQUNBLGdCQUFLLElBQUwsR0FBWSxRQUFRLFdBQXBCO0FBQ0QsU0FIRDtBQUlEO0FBQ0YsS0F6Q0s7O0FBMkNOLGtCQUFjLHNCQUFTLElBQVQsRUFBZTtBQUMzQixVQUFJLGVBQWUsSUFBZixDQUFKLEVBQTBCO0FBQ3hCLGFBQUssVUFBTCxDQUFnQixLQUFLLFVBQUwsQ0FBZ0IsT0FBTyxlQUFlLElBQWYsQ0FBUCxHQUE4QixPQUE5QyxDQUFoQixFQUF3RSxJQUF4RSxFQUE4RSxJQUE5RSxFQUFvRixJQUFwRjtBQUNEO0FBQ0QsV0FBSyxTQUFMLEdBQWlCLElBQWpCO0FBQ0QsS0FoREs7O0FBa0ROLG9CQUFnQix3QkFBUyxHQUFULEVBQWM7QUFDNUIsYUFBTyxRQUFRLE9BQVIsQ0FBZ0IsY0FBaEIsQ0FBK0IsR0FBL0IsQ0FBUDtBQUNELEtBcERLOztBQXNETix3QkFBb0IsNEJBQVMsR0FBVCxFQUFjLEtBQWQsRUFBcUI7QUFDdkMsYUFBTyxLQUFLLGNBQUwsQ0FBb0IsTUFBTSxLQUExQixDQUFQO0FBQ0QsS0F4REs7O0FBMEROLG9CQUFnQix3QkFBUyxLQUFULEVBQWdCO0FBQzlCLGFBQU8sS0FBSyxjQUFMLENBQW9CLFFBQVEsTUFBUixDQUFlLGFBQWYsR0FBK0IsS0FBbkQsQ0FBUDtBQUNELEtBNURLOztBQThETix5QkFBcUIsNkJBQVMsQ0FBVCxFQUFZO0FBQUE7O0FBQy9CLFVBQUksV0FBVyxFQUFFLEtBQUYsQ0FBUSxJQUF2QjtBQUNBLFVBQUksTUFBTSxLQUFLLElBQUwsQ0FBVSxLQUFWLENBQWdCLE9BQWhCLENBQXdCLFFBQXhCLENBQVY7QUFDQSxVQUFJLFlBQVksU0FBUyxLQUFULEdBQWlCLFNBQVMsR0FBMUM7O0FBRUEsY0FBUSxHQUFSLENBQVksSUFBWixDQUFpQixhQUFqQixDQUErQixFQUFDLElBQUksU0FBUyxFQUFkLEVBQS9CLEVBQWtELElBQWxELENBQXVELG9CQUFZO0FBQ2pFLGVBQUssTUFBTCxDQUFZLFlBQVosRUFBMEIsR0FBMUIsRUFBK0IsQ0FBL0I7QUFDQSxlQUFLLEdBQUwsQ0FBUyxZQUFULEVBQXVCLE9BQUssSUFBTCxDQUFVLEtBQVYsR0FBa0IsU0FBekM7QUFDRCxPQUhELEVBR0csS0FISCxDQUdTO0FBQUEsZUFBTyxRQUFRLEdBQVIsQ0FBWSxHQUFaLENBQVA7QUFBQSxPQUhUO0FBSUQsS0F2RUs7O0FBeUVOLHlCQUFxQiw2QkFBUyxDQUFULEVBQVk7QUFBQTs7QUFDL0IsVUFBSSxXQUFXLEVBQUUsS0FBRixDQUFRLElBQXZCO0FBQ0EsVUFBSSxNQUFNLEtBQUssSUFBTCxDQUFVLEtBQVYsQ0FBZ0IsT0FBaEIsQ0FBd0IsUUFBeEIsQ0FBVjs7QUFFQSxjQUFRLEdBQVIsQ0FBWSxJQUFaLENBQWlCLFVBQWpCLENBQTRCO0FBQzFCLFlBQUksU0FBUyxFQURhO0FBRTFCLGFBQUs7QUFGcUIsT0FBNUIsRUFHRyxJQUhILENBR1Esb0JBQVk7QUFDbEIsZUFBSyxHQUFMLENBQVMsZ0JBQWdCLEdBQWhCLEdBQXNCLE1BQS9CLEVBQXVDLFNBQVMsR0FBVCxHQUFlLENBQXREO0FBQ0EsZUFBSyxHQUFMLENBQVMsWUFBVCxFQUF1QixPQUFLLElBQUwsQ0FBVSxLQUFWLEdBQWtCLFNBQVMsS0FBbEQ7QUFDRCxPQU5ELEVBTUcsS0FOSCxDQU1TO0FBQUEsZUFBTyxRQUFRLEdBQVIsQ0FBWSxHQUFaLENBQVA7QUFBQSxPQU5UO0FBT0QsS0FwRks7O0FBc0ZOLHlCQUFxQiw2QkFBUyxDQUFULEVBQVk7QUFBQTs7QUFDL0IsVUFBSSxXQUFXLEVBQUUsS0FBRixDQUFRLElBQXZCO0FBQ0EsVUFBSSxNQUFNLEtBQUssSUFBTCxDQUFVLEtBQVYsQ0FBZ0IsT0FBaEIsQ0FBd0IsUUFBeEIsQ0FBVjs7QUFFQSxjQUFRLEdBQVIsQ0FBWSxJQUFaLENBQWlCLGFBQWpCLENBQStCO0FBQzdCLFlBQUksU0FBUyxFQURnQjtBQUU3QixhQUFLO0FBRndCLE9BQS9CLEVBR0csSUFISCxDQUdRLG9CQUFZO0FBQ2xCLFlBQUksU0FBUyxHQUFULEtBQWlCLENBQXJCLEVBQXdCO0FBQ3RCLGlCQUFLLE1BQUwsQ0FBWSxZQUFaLEVBQTBCLEdBQTFCLEVBQStCLENBQS9CO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsaUJBQUssR0FBTCxDQUFTLGdCQUFnQixHQUFoQixHQUFzQixNQUEvQixFQUF1QyxTQUFTLEdBQVQsR0FBZSxDQUF0RDtBQUNEO0FBQ0QsZUFBSyxHQUFMLENBQVMsWUFBVCxFQUF1QixPQUFLLElBQUwsQ0FBVSxLQUFWLEdBQWtCLFNBQVMsS0FBbEQ7QUFDRCxPQVZELEVBVUcsS0FWSCxDQVVTO0FBQUEsZUFBTyxRQUFRLEdBQVIsQ0FBWSxHQUFaLENBQVA7QUFBQSxPQVZUO0FBV0QsS0FyR0s7O0FBdUdOLDJCQUF1QiwrQkFBUyxDQUFULEVBQVk7QUFDakMsUUFBRSxjQUFGOztBQUVBLFdBQUssQ0FBTCxDQUFPLFlBQVAsQ0FBb0IsS0FBcEIsR0FBNEIsT0FBTyxLQUFLLENBQUwsQ0FBTyxVQUFQLENBQWtCLFNBQWxCLEdBQThCLE1BQWpFO0FBQ0EsV0FBSyxDQUFMLENBQU8sWUFBUCxDQUFvQixJQUFwQixHQUEyQixhQUEzQjtBQUNELEtBNUdLOztBQThHTix5QkFBcUIsNkJBQVMsQ0FBVCxFQUFZO0FBQy9CLFdBQUssR0FBTCxDQUFTLFlBQVQsRUFBdUIsZ0JBQXZCO0FBQ0EsV0FBSyxDQUFMLENBQU8sVUFBUCxDQUFrQixNQUFsQjtBQUNELEtBakhLOztBQW1ITixtQkFBZSx5QkFBVztBQUFBOztBQUN4QixVQUFJLGlCQUFpQixRQUFRLEdBQVIsQ0FBWSxJQUFaLENBQWlCLEdBQWpCLEVBQXJCO0FBQ0EscUJBQWUsSUFBZixDQUFvQixvQkFBWTtBQUM5QixlQUFLLElBQUwsR0FBWSxTQUFTLElBQXJCO0FBQ0EsZUFBSyxDQUFMLENBQU8sd0JBQVAsQ0FBZ0MsTUFBaEMsR0FBeUMsS0FBekM7QUFDRCxPQUhELEVBR0csS0FISCxDQUdTO0FBQUEsZUFBTyxRQUFRLEdBQVIsQ0FBWSxHQUFaLENBQVA7QUFBQSxPQUhUOztBQUtBLFVBQUksaUJBQWlCLFFBQVEsR0FBUixDQUFZLElBQVosQ0FBaUIsT0FBakIsQ0FBeUI7QUFDNUMsbUJBQVcsUUFBUTtBQUR5QixPQUF6QixDQUFyQjtBQUdBLHFCQUFlLElBQWYsQ0FBb0I7QUFBQSxlQUFRLE9BQUssSUFBTCxHQUFZLElBQXBCO0FBQUEsT0FBcEI7O0FBRUEsYUFBTyxJQUFJLE9BQUosQ0FBWSxVQUFDLE9BQUQsRUFBVSxNQUFWLEVBQXFCO0FBQ3RDLGdCQUFRLEdBQVIsQ0FBWSxDQUFDLGNBQUQsRUFBaUIsY0FBakIsQ0FBWixFQUE4QyxJQUE5QyxDQUFtRCxZQUFNO0FBQ3ZEO0FBQ0QsU0FGRDtBQUdELE9BSk0sQ0FBUDtBQUtEO0FBcElLLEdBQVI7QUFzSUQsQ0E3SUwsRUE2SU8sTUE3SVAsRUE2SWUsUUE3SWYsRUE2SXlCLFNBN0l6QixFQTZJb0MsT0E3SXBDLEVBNkk2QyxLQTdJN0MiLCJmaWxlIjoicGFnZXMvc3RvcmUtbWFpbi1wYWdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCwgcGFuZWlybywgamFtYm8pIHtcbiAgICAgIHZhciBwYXRoRWxlbWVudE1hcCA9IHtcbiAgICAgICAgJ2NhdGVnb3JpYSc6ICdjYXRlZ29yeS1wYWdlJywgICAgICAgIFxuICAgICAgICAnYnVzY2EnOiAnc2VhcmNoLXBhZ2UnLFxuICAgICAgICAnZmVjaGFyLXBlZGlkbyc6ICdjaGVja291dC1wYWdlJ1xuICAgICAgfTtcblxuICAgICAgUG9seW1lcih7XG4gICAgICAgIGlzOiAnc3RvcmUtbWFpbi1wYWdlJyxcblxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgY2F0ZWdvcmllczogT2JqZWN0LFxuICAgICAgICAgIGNhcnQ6IHtcbiAgICAgICAgICAgIHR5cGU6IE9iamVjdCxcbiAgICAgICAgICAgIG5vdGlmeTogdHJ1ZVxuICAgICAgICAgIH0sICBcbiAgICAgICAgICBmaXJzdExvYWQ6IEJvb2xlYW4sICAgICAgICBcbiAgICAgICAgICByb3V0ZTogT2JqZWN0LFxuICAgICAgICAgIHVzZXI6IE9iamVjdCxcbiAgICAgICAgICBwYWdlOiB7XG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgICAgICByZWZsZWN0VG9BdHRyaWJ1dGU6IHRydWUsXG4gICAgICAgICAgICBvYnNlcnZlcjogJ19wYWdlQ2hhbmdlZCdcbiAgICAgICAgICB9LCAgICAgICAgICBcbiAgICAgICAgICBzZWxlY3RlZENhdGVnb3J5OiB7XG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgICAgICBub3RpZnk6IHRydWVcbiAgICAgICAgICB9ICBcbiAgICAgICAgfSxcblxuICAgICAgICBhdHRhY2hlZDogZnVuY3Rpb24oKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgaWYgKCFwYW5laXJvLnVzZXJUb2tlbiB8fCBwYW5laXJvLnVzZXJUb2tlbiA9PT0gJycpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuJC5pcm9uTG9jYXRpb24uc2V0KCdwYXRoJywgJy8nKTsgICAgICAgICAgICBcbiAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0sXG5cbiAgICAgICAgb2JzZXJ2ZXJzOiBbXG4gICAgICAgICAgJ19yb3V0ZVBhZ2VDaGFuZ2VkKHJvdXRlRGF0YS5wYWdlKSdcbiAgICAgICAgXSwgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgX3JvdXRlUGFnZUNoYW5nZWQ6IGZ1bmN0aW9uKHBhZ2UpIHtcbiAgICAgICAgICBpZiAocGFuZWlyby51c2VyVG9rZW4pIHsgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHZhciBwcm9taXNlID0gKCF0aGlzLnVzZXIpID8gdGhpcy5fbG9hZFVzZXJEYXRhKCkgOiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgICAgIHByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuJC5sb2FkaW5nU3Bpbm5lci5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgdGhpcy5wYWdlID0gcGFnZSB8fCAnY2F0ZWdvcmlhJztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9LFxuXG4gICAgICAgIF9wYWdlQ2hhbmdlZDogZnVuY3Rpb24ocGFnZSkgeyAgICAgICAgICBcbiAgICAgICAgICBpZiAocGF0aEVsZW1lbnRNYXBbcGFnZV0pIHsgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuaW1wb3J0SHJlZih0aGlzLnJlc29sdmVVcmwoJy4vJyArIHBhdGhFbGVtZW50TWFwW3BhZ2VdICsgJy5odG1sJyksIG51bGwsIG51bGwsIHRydWUpO1xuICAgICAgICAgIH0gICAgICAgIFxuICAgICAgICAgIHRoaXMuZmlyc3RMb2FkID0gdHJ1ZTtcbiAgICAgICAgfSxcblxuICAgICAgICBjdXJyZW5jeUZvcm1hdDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgcmV0dXJuIHBhbmVpcm8uY29tbW9ucy5jdXJyZW5jeUZvcm1hdCh2YWwpO1xuICAgICAgICB9LFxuXG4gICAgICAgIHRvdGFsQ2FydEl0ZW1QcmljZTogZnVuY3Rpb24ocXR5LCBwcmljZSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbmN5Rm9ybWF0KHF0eSAqIHByaWNlKTtcbiAgICAgICAgfSxcblxuICAgICAgICB0b3RhbENhcnRQcmljZTogZnVuY3Rpb24ocHJpY2UpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW5jeUZvcm1hdChwYW5laXJvLmNvbmZpZy5zaGlwcGluZ1ByaWNlICsgcHJpY2UpO1xuICAgICAgICB9LFxuXG4gICAgICAgIG9uUmVtb3ZlQ2FydEl0ZW1UYXA6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICB2YXIgY2FydEl0ZW0gPSBlLm1vZGVsLml0ZW07XG4gICAgICAgICAgdmFyIGlkeCA9IHRoaXMuY2FydC5pdGVtcy5pbmRleE9mKGNhcnRJdGVtKTtcbiAgICAgICAgICB2YXIgaXRlbVByaWNlID0gY2FydEl0ZW0ucHJpY2UgKiBjYXJ0SXRlbS5xdHk7XG5cbiAgICAgICAgICBwYW5laXJvLmFwaS5jYXJ0LnJlbW92ZVByb2R1Y3Qoe2lkOiBjYXJ0SXRlbS5pZH0pLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgdGhpcy5zcGxpY2UoJ2NhcnQuaXRlbXMnLCBpZHgsIDEpO1xuICAgICAgICAgICAgdGhpcy5zZXQoJ2NhcnQudG90YWwnLCB0aGlzLmNhcnQudG90YWwgLSBpdGVtUHJpY2UpOyAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcbiAgICAgICAgfSxcblxuICAgICAgICBvbkluY0NhcnRJdGVtUXR5VGFwOiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgdmFyIGNhcnRJdGVtID0gZS5tb2RlbC5pdGVtO1xuICAgICAgICAgIHZhciBpZHggPSB0aGlzLmNhcnQuaXRlbXMuaW5kZXhPZihjYXJ0SXRlbSk7ICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICBwYW5laXJvLmFwaS5jYXJ0LmFkZFByb2R1Y3Qoe1xuICAgICAgICAgICAgaWQ6IGNhcnRJdGVtLmlkLFxuICAgICAgICAgICAgcXR5OiAxXG4gICAgICAgICAgfSkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldCgnY2FydC5pdGVtcy4nICsgaWR4ICsgJy5xdHknLCBjYXJ0SXRlbS5xdHkgKyAxKTtcbiAgICAgICAgICAgIHRoaXMuc2V0KCdjYXJ0LnRvdGFsJywgdGhpcy5jYXJ0LnRvdGFsICsgY2FydEl0ZW0ucHJpY2UpOyAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcbiAgICAgICAgfSxcblxuICAgICAgICBvbkRlY0NhcnRJdGVtUXR5VGFwOiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgdmFyIGNhcnRJdGVtID0gZS5tb2RlbC5pdGVtO1xuICAgICAgICAgIHZhciBpZHggPSB0aGlzLmNhcnQuaXRlbXMuaW5kZXhPZihjYXJ0SXRlbSk7ICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICBwYW5laXJvLmFwaS5jYXJ0LnJlbW92ZVByb2R1Y3Qoe1xuICAgICAgICAgICAgaWQ6IGNhcnRJdGVtLmlkLFxuICAgICAgICAgICAgcXR5OiAxXG4gICAgICAgICAgfSkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAoY2FydEl0ZW0ucXR5ID09PSAxKSB7XG4gICAgICAgICAgICAgIHRoaXMuc3BsaWNlKCdjYXJ0Lml0ZW1zJywgaWR4LCAxKTsgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5zZXQoJ2NhcnQuaXRlbXMuJyArIGlkeCArICcucXR5JywgY2FydEl0ZW0ucXR5IC0gMSk7ICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5zZXQoJ2NhcnQudG90YWwnLCB0aGlzLmNhcnQudG90YWwgLSBjYXJ0SXRlbS5wcmljZSk7IFxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcbiAgICAgICAgfSxcblxuICAgICAgICBvblNlYXJjaEZvcm1QcmVzdWJtaXQ6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgXG4gICAgICAgICAgdGhpcy4kLmlyb25Mb2NhdGlvbi5xdWVyeSA9ICdxPScgKyB0aGlzLiQuc2VhcmNoRm9ybS5zZXJpYWxpemUoKS5zZWFyY2g7XG4gICAgICAgICAgdGhpcy4kLmlyb25Mb2NhdGlvbi5wYXRoID0gJy9sb2phL2J1c2NhJzsgICAgICAgICAgICAgIFxuICAgICAgICB9LCAgXG5cbiAgICAgICAgb25DaGVja291dEJ1dHRvblRhcDogZnVuY3Rpb24oZSkgeyAgICAgICAgICBcbiAgICAgICAgICB0aGlzLnNldCgncm91dGUucGF0aCcsICcvZmVjaGFyLXBlZGlkbycpO1xuICAgICAgICAgIHRoaXMuJC5jYXJ0RHJhd2VyLnRvZ2dsZSgpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9sb2FkVXNlckRhdGE6IGZ1bmN0aW9uKCkgeyAgICAgICAgICBcbiAgICAgICAgICB2YXIgZ2V0Q2FydFByb21pc2UgPSBwYW5laXJvLmFwaS5jYXJ0LmdldCgpO1xuICAgICAgICAgIGdldENhcnRQcm9taXNlLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgdGhpcy5jYXJ0ID0gcmVzcG9uc2UuZGF0YTsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuJC5jYXJ0RHJhd2VyTG9hZGluZ1NwaW5uZXIuYWN0aXZlID0gZmFsc2U7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgfSkuY2F0Y2goZXJyID0+IGNvbnNvbGUubG9nKGVycikpO1xuXG4gICAgICAgICAgdmFyIGdldFVzZXJQcm9taXNlID0gcGFuZWlyby5hcGkudXNlci5nZXREYXRhKHtcbiAgICAgICAgICAgIHVzZXJUb2tlbjogcGFuZWlyby51c2VyVG9rZW5cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBnZXRVc2VyUHJvbWlzZS50aGVuKHVzZXIgPT4gdGhpcy51c2VyID0gdXNlcik7XG5cbiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgUHJvbWlzZS5hbGwoW2dldENhcnRQcm9taXNlLCBnZXRVc2VyUHJvbWlzZV0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTsgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSkod2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkLCBwYW5laXJvLCBqYW1ibyk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
